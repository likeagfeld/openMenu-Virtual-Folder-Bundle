<Window x:Class="GDMENUCardManager.BatchFolderRenameWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:GDMENUCardManager"
        xmlns:conv="clr-namespace:GDMENUCardManager.Converter"
        Title="Batch Folder Rename" Height="600" Width="500"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">
    <Window.Resources>
        <conv:BoolToVisibleOrCollapsedConverter x:Key="BoolToVisibleOrCollapsed"/>
    </Window.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Margin="0,0,0,10" TextWrapping="Wrap">
            <Run FontWeight="Bold">Folder Hierarchy</Run>
            <LineBreak/>
            Double-click to rename folders. Drag folders to reparent them. Changes apply when you click Save.
        </TextBlock>

        <Border Grid.Row="1" BorderBrush="#CCCCCC" BorderThickness="1">
            <TreeView x:Name="FolderTreeView"
                      ItemsSource="{Binding RootNodes}"
                      AllowDrop="True"
                      PreviewMouseLeftButtonDown="TreeView_PreviewMouseLeftButtonDown"
                      MouseMove="TreeView_MouseMove"
                      DragEnter="TreeView_DragEnter"
                      DragOver="TreeView_DragOver"
                      DragLeave="TreeView_DragLeave"
                      Drop="TreeView_Drop">
                <TreeView.ItemContainerStyle>
                    <Style TargetType="TreeViewItem">
                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                        <EventSetter Event="MouseDoubleClick" Handler="TreeViewItem_MouseDoubleClick"/>
                    </Style>
                </TreeView.ItemContainerStyle>
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                        <Border x:Name="ItemBorder"
                                Background="Transparent"
                                Padding="2"
                                CornerRadius="2">
                            <Grid>
                                <TextBlock Text="{Binding DisplayName}"
                                           Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibleOrCollapsed}, ConverterParameter=Inverse}"/>
                                <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                         Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibleOrCollapsed}}"
                                         LostFocus="EditTextBox_LostFocus"
                                         KeyDown="EditTextBox_KeyDown"
                                         Loaded="EditTextBox_Loaded"/>
                            </Grid>
                        </Border>
                        <HierarchicalDataTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsDropTarget}" Value="True">
                                <Setter TargetName="ItemBorder" Property="Background" Value="#ADD8E6"/>
                                <Setter TargetName="ItemBorder" Property="BorderBrush" Value="#4682B4"/>
                                <Setter TargetName="ItemBorder" Property="BorderThickness" Value="1"/>
                            </DataTrigger>
                        </HierarchicalDataTemplate.Triggers>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>
        </Border>

        <Grid Grid.Row="2" Margin="0,10,0,0">
            <Button HorizontalAlignment="Left" Content="Undo Last Change" Width="130" Height="30"
                    Click="UndoButton_Click" IsEnabled="{Binding CanUndo}"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Save" Width="80" Height="30" Margin="0,0,10,0" Click="SaveButton_Click" IsDefault="True"/>
                <Button Content="Cancel" Width="80" Height="30" Click="CancelButton_Click" IsCancel="True"/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>
